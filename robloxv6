-- ====================== FEDLY SCRIPT HUB V14 (DENGAN HEARTBEAT) ======================
local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

-- ================= KONFIGURASI =================
local DISCORD_LINK = "https://discord.com/invite/KWRuqUxt"
local GAS_URL = "https://script.google.com/macros/s/AKfycbx9yUv2UMtiqMzsgZJkYRqKfJT8d6MnhO-gpblnmeSkqhLS2d8ZxEVbGWIx3RgC9mHn4Q/exec"
local VIP_SCRIPT_URL = "https://pastebin.com/raw/UNNHEtVH"

-- ================= VARIABEL HEARTBEAT =================
local heartbeatThread = nil
local currentKey = ""
local currentUserId = ""

-- ================= FUNGSI HEARTBEAT =================
local function startHeartbeat(key, userId)
    -- Stop heartbeat lama jika ada
    if heartbeatThread then
        coroutine.close(heartbeatThread)
        heartbeatThread = nil
    end
    
    print("üíì Starting heartbeat system...")
    print("Key:", key)
    print("UserID:", userId)
    
    heartbeatThread = task.spawn(function()
        local heartbeatCount = 0
        
        while true do
            task.wait(60) -- Setiap 60 detik
            
            heartbeatCount = heartbeatCount + 1
            local url = GAS_URL .. "?action=heartbeat&key=" .. key .. "&userid=" .. userId
            
            print("üíì Heartbeat #" .. heartbeatCount .. " sending...")
            
            local success, response = pcall(function()
                return game:HttpGet(url, true, {Timeout = 10})
            end)
            
            if success then
                print("üíì Heartbeat #" .. heartbeatCount .. " sent successfully")
            else
                warn("‚ö†Ô∏è Heartbeat #" .. heartbeatCount .. " failed:", response)
            end
        end
    end)
end

local function stopHeartbeat()
    if heartbeatThread then
        coroutine.close(heartbeatThread)
        heartbeatThread = nil
        print("üíì Heartbeat stopped")
    end
end

-- ================= BERSIHKAN UI LAMA =================
for _, gui in pairs(PlayerGui:GetChildren()) do
    if gui.Name == "FedlyHubV14" then gui:Destroy() end
end

-- ================= SCREEN GUI =================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FedlyHubV14"
screenGui.IgnoreGuiInset = true
screenGui.Parent = PlayerGui

-- ================= FLOATING ICON =================
local floatBtn = Instance.new("ImageButton")
floatBtn.Size = UDim2.new(0, 50, 0, 50)
floatBtn.Position = UDim2.new(0.05, 0, 0.1, 0)
floatBtn.BackgroundColor3 = Color3.fromRGB(106, 13, 173)
floatBtn.Image = "rbxassetid://6031068433"
floatBtn.Parent = screenGui
Instance.new("UICorner", floatBtn).CornerRadius = UDim.new(1, 0)
local floatStroke = Instance.new("UIStroke", floatBtn)
floatStroke.Color = Color3.fromRGB(0, 255, 136)
floatStroke.Thickness = 2

-- Draggable Logic
local dragging, dragStart, startPos
floatBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = floatBtn.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        floatBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
floatBtn.InputEnded:Connect(function(input) dragging = false end)

-- ================= MAIN FRAME (LANDSCAPE) =================
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0.65, 0, 0.6, 0)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 15)
mainFrame.BackgroundTransparency = 0.15
mainFrame.Visible = false
mainFrame.Parent = screenGui

local sizeConstraint = Instance.new("UISizeConstraint", mainFrame)
sizeConstraint.MaxSize = Vector2.new(500, 260)

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 18)
local mainStroke = Instance.new("UIStroke", mainFrame)
mainStroke.Thickness = 3
mainStroke.Color = Color3.fromRGB(106, 13, 173)

local layout = Instance.new("UIListLayout", mainFrame)
layout.Padding = UDim.new(0, 12)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Center
layout.SortOrder = Enum.SortOrder.LayoutOrder

-- 1. JUDUL
local title = Instance.new("TextLabel", mainFrame)
title.LayoutOrder = 1
title.Size = UDim2.new(0.9, 0, 0, 45)
title.BackgroundTransparency = 1
title.Text = "‚ú® FEDLY SCRIPT HUB ‚ú®"
title.TextColor3 = Color3.fromRGB(0, 255, 136)
title.Font = Enum.Font.GothamBold
title.TextSize = 26
title.TextScaled = true

-- 2. DAFTAR HARGA
local priceContainer = Instance.new("Frame", mainFrame)
priceContainer.LayoutOrder = 2
priceContainer.Size = UDim2.new(0.9, 0, 0, 35)
priceContainer.BackgroundTransparency = 1

local p1 = Instance.new("TextLabel", priceContainer)
p1.Size = UDim2.new(1, 0, 0, 16)
p1.BackgroundTransparency = 1
p1.Text = "‚Ä¢ 1 MONTH : Rp 50.000"
p1.TextColor3 = Color3.fromRGB(245, 245, 245)
p1.Font = Enum.Font.GothamBold
p1.TextSize = 14

local p2 = Instance.new("TextLabel", priceContainer)
p2.Position = UDim2.new(0, 0, 0, 18)
p2.Size = UDim2.new(1, 0, 0, 16)
p2.BackgroundTransparency = 1
p2.Text = "‚Ä¢ PERMANENT : Rp 200.000"
p2.TextColor3 = Color3.fromRGB(245, 245, 245)
p2.Font = Enum.Font.GothamBold
p2.TextSize = 14

-- 3. INPUT KEY
local keyBox = Instance.new("TextBox", mainFrame)
keyBox.LayoutOrder = 3
keyBox.Size = UDim2.new(0.8, 0, 0, 40)
keyBox.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
keyBox.PlaceholderText = "Paste License Key Here..."
keyBox.Text = ""
keyBox.TextColor3 = Color3.fromRGB(0, 255, 150)
keyBox.Font = Enum.Font.GothamBold
keyBox.TextSize = 14
Instance.new("UICorner", keyBox).CornerRadius = UDim.new(0, 8)

-- 4. BUTTON ROW (DC KIRI, VERIF KANAN)
local btnRow = Instance.new("Frame", mainFrame)
btnRow.LayoutOrder = 4
btnRow.Size = UDim2.new(0.8, 0, 0, 42)
btnRow.BackgroundTransparency = 1

local dcBtn = Instance.new("TextButton", btnRow)
dcBtn.Size = UDim2.new(0.48, 0, 1, 0)
dcBtn.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
dcBtn.Text = "JOIN DISCORD"
dcBtn.TextColor3 = Color3.new(1, 1, 1)
dcBtn.Font = Enum.Font.GothamBold
dcBtn.TextSize = 14
Instance.new("UICorner", dcBtn).CornerRadius = UDim.new(0, 8)

local verifyBtn = Instance.new("TextButton", btnRow)
verifyBtn.Position = UDim2.new(0.52, 0, 0, 0)
verifyBtn.Size = UDim2.new(0.48, 0, 1, 0)
verifyBtn.BackgroundColor3 = Color3.fromRGB(106, 13, 173)
verifyBtn.Text = "VERIFY KEY"
verifyBtn.TextColor3 = Color3.new(1, 1, 1)
verifyBtn.Font = Enum.Font.GothamBold
verifyBtn.TextSize = 14
Instance.new("UICorner", verifyBtn).CornerRadius = UDim.new(0, 8)

-- 5. STATUS
local status = Instance.new("TextLabel", mainFrame)
status.LayoutOrder = 5
status.Size = UDim2.new(0.8, 0, 0, 20)
status.BackgroundTransparency = 1
status.Text = "Status: Idle"
status.TextColor3 = Color3.fromRGB(150, 150, 150)
status.Font = Enum.Font.Gotham
status.TextSize = 12

-- ================= LOGIKA VERIFIKASI (SIMPLE & CLEAN) =================

local function verifyKey()
    local key = string.gsub(keyBox.Text, "%s+", "")
    if #key == 0 then 
        status.Text = "‚ùå Key tidak boleh kosong"
        status.TextColor3 = Color3.fromRGB(255, 80, 80)
        return 
    end
    
    status.Text = "üîê Memverifikasi..."
    status.TextColor3 = Color3.fromRGB(255, 255, 100)
    verifyBtn.Text = "LOADING..."
    verifyBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    
    -- Simpan key dan user ID untuk heartbeat
    currentKey = key
    currentUserId = tostring(Player.UserId)
    
    -- Buat URL dengan format yang benar
    local url = GAS_URL .. "?key=" .. key .. "&userid=" .. Player.UserId
    
    -- DEBUG
    print("=== VERIFICATION REQUEST ===")
    print("URL:", url)
    
    local success, response = pcall(function()
        return game:HttpGet(url, true, {Timeout = 15})
    end)
    
    verifyBtn.Text = "VERIFY KEY"
    verifyBtn.BackgroundColor3 = Color3.fromRGB(106, 13, 173)
    
    if not success then
        status.Text = "‚ùå Gagal menghubungi server"
        status.TextColor3 = Color3.fromRGB(255, 80, 80)
        return
    end
    
    if not response or response == "" then
        status.Text = "‚ö†Ô∏è Server tidak merespon"
        status.TextColor3 = Color3.fromRGB(255, 165, 0)
        return
    end
    
    print("Server Response:", string.sub(response, 1, 200))
    
    -- 1. Coba sebagai Lua code (format GAS lama)
    local chunk, err = loadstring(response)
    if chunk then
        -- Key VALID! Hapus UI dan load skrip utama
        status.Text = "‚úÖ Key Valid! Memuat..."
        status.TextColor3 = Color3.fromRGB(0, 255, 100)
        
        -- MULAI HEARTBEAT SYSTEM
        startHeartbeat(key, currentUserId)
        
        -- HAPUS UI VERIFIKASI DENGAN CEPAT
        task.wait(0.8)
        screenGui:Destroy()  -- HAPUS SEMUA UI INI
        
        -- LOAD SKRIP UTAMA DARI PASTEBIN
        task.spawn(function()
            local success, vipScript = pcall(function()
                return game:HttpGet(VIP_SCRIPT_URL, true)
            end)
            
            if success and vipScript then
                local chunk2, err2 = loadstring(vipScript)
                if chunk2 then
                    pcall(chunk2)  -- Jalankan skrip utama (yang punya UI sendiri)
                    print("‚úÖ Skrip utama berhasil di-load")
                else
                    warn("Gagal compile skrip utama:", err2)
                end
            else
                warn("Gagal download skrip utama")
            end
        end)
        
        return
    end
    
    -- 2. Coba sebagai JSON (format baru dengan heartbeat)
    local jsonSuccess, data = pcall(HttpService.JSONDecode, HttpService, response)
    if jsonSuccess and type(data) == "table" then
        if data.success == true then
            status.Text = "‚úÖ Key Valid!"
            status.TextColor3 = Color3.fromRGB(0, 255, 100)
            
            -- MULAI HEARTBEAT SYSTEM
            startHeartbeat(key, currentUserId)
            
            task.wait(0.8)
            screenGui:Destroy()  -- HAPUS UI
            
            -- Load skrip utama
            task.spawn(function()
                loadstring(game:HttpGet(VIP_SCRIPT_URL, true))()
            end)
            
            return
        else
            status.Text = "‚ùå " .. (data.message or "Key invalid")
            status.TextColor3 = Color3.fromRGB(255, 80, 80)
            return
        end
    end
    
    -- 3. Cek plain text
    local lowerResponse = string.lower(response)
    if string.find(lowerResponse, "valid") or 
       string.find(lowerResponse, "success") or 
       string.find(lowerResponse, "true") then
        
        status.Text = "‚úÖ Key Diterima!"
        status.TextColor3 = Color3.fromRGB(0, 255, 100)
        
        -- MULAI HEARTBEAT SYSTEM
        startHeartbeat(key, currentUserId)
        
        task.wait(0.8)
        screenGui:Destroy()  -- HAPUS UI
        
        -- Load skrip utama
        task.spawn(function()
            loadstring(game:HttpGet(VIP_SCRIPT_URL, true))()
        end)
        
    else
        status.Text = "‚ùå Key Invalid"
        status.TextColor3 = Color3.fromRGB(255, 80, 80)
    end
end

-- ================= KONEKSI EVENT =================
floatBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

dcBtn.MouseButton1Click:Connect(function()
    if setclipboard then
        setclipboard(DISCORD_LINK)
        status.Text = "‚úì Link Disalin!"
        status.TextColor3 = Color3.fromRGB(100, 255, 100)
        task.wait(2)
        status.Text = "Status: Idle"
        status.TextColor3 = Color3.fromRGB(150, 150, 150)
    end
end)

verifyBtn.MouseButton1Click:Connect(verifyKey)

keyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        verifyKey()
    end
end)

-- Cleanup saat game ditutup
game:BindToClose(function()
    stopHeartbeat()
    
    -- Kirim logout jika ada key aktif
    if currentKey and currentKey ~= "" and currentUserId and currentUserId ~= "" then
        pcall(function()
            local logoutUrl = GAS_URL .. "?action=logout&key=" .. currentKey .. "&userid=" .. currentUserId
            game:HttpGet(logoutUrl, true)
            print("üö™ Logout sent on game close")
        end)
    end
end)

print("=== UI VERIFIKASI FEDLY HUB LOADED ===")
print("üíì Heartbeat System: READY")
print("üì° GAS URL:", GAS_URL)
print("Tugas: Verifikasi key ‚Üí Start heartbeat ‚Üí Load skrip utama ‚Üí Hapus UI")
